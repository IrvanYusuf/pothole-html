<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>WebRTC YOLO Client</title>
    <style>
      #container {
        position: relative;
        width: 640px;
        margin: auto;
      }
      video,
      canvas {
        position: absolute;
        top: 0;
        left: 0;
      }
      canvas {
        pointer-events: none;
      }

      .text {
        text-align: center;
      }

      .link-container {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 10px;
      }
      #fps {
        text-align: center;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h3 class="text">WebRTC + YOLO (client)</h3>
    <div class="link-container">
      <a href="index.html">webRTC</a>
      <a href="websocket.html">webSocket</a>
      <a href="mobile.html">mobile</a>
    </div>
    <div id="fps">FPS: 0</div>
    <div id="container">
      <video id="localVideo" autoplay muted playsinline></video>
      <canvas id="overlay"></canvas>
    </div>

    <script>
      const pc = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
      });

      let dc = pc.createDataChannel("detections");
      dc.onopen = () => console.log("DataChannel open");
      dc.onmessage = (evt) => {
        console.log("Detections received:", evt.data);
        handleDetections(evt.data);
      };

      const localVideo = document.getElementById("localVideo");
      const overlay = document.getElementById("overlay");
      const ctx = overlay.getContext("2d");
      const fpsEl = document.getElementById("fps");

      let lastFrameTime = 0;
      let frameCount = 0;
      let fps = 0;
      let lastDraw = 0; // inisialisasi throttling render

      navigator.mediaDevices
        .getUserMedia({
          video: { width: 640, height: 480, frameRate: { ideal: 15, max: 20 } },
          audio: false,
        })
        .then((stream) => {
          localVideo.srcObject = stream;

          // set canvas ukuran sesuai video
          localVideo.onloadedmetadata = () => {
            overlay.width = localVideo.videoWidth;
            overlay.height = localVideo.videoHeight;
          };

          // tambahkan track ke PeerConnection
          stream.getTracks().forEach((t) => pc.addTrack(t, stream));
          startNegotiation();
        })
        .catch((err) => console.error("getUserMedia error:", err));

      function handleDetections(message) {
        // throttling render 10 FPS
        if (performance.now() - lastDraw < 100) return;
        lastDraw = performance.now();

        let data;
        try {
          data = JSON.parse(message);
        } catch (e) {
          return;
        }

        ctx.clearRect(0, 0, overlay.width, overlay.height);
        if (!data.detections) return;

        ctx.lineWidth = 4;
        ctx.font = "18px Arial";

        data.detections.forEach((det) => {
          const videoWidth = localVideo.videoWidth;
          const videoHeight = localVideo.videoHeight;

          const x = det.x * videoWidth;
          const y = det.y * videoHeight;
          const w = det.w * videoWidth;
          const h = det.h * videoHeight;

          // blue bounding box
          ctx.strokeStyle = "blue";
          ctx.strokeRect(x, y, w, h);

          // label background
          const labelText = det.label + " " + det.confidence;
          const textWidth = ctx.measureText(labelText).width;
          const textHeight = 20;

          ctx.fillStyle = "blue";
          ctx.fillRect(x, y - textHeight, textWidth + 10, textHeight + 6);

          ctx.fillStyle = "white";
          ctx.fillText(labelText, x + 5, y - 4);
        });
      }

      async function startNegotiation() {
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);

        const resp = await fetch("https://08227fa66d06.ngrok-free.app/offer", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            sdp: pc.localDescription.sdp,
            type: pc.localDescription.type,
          }),
        });

        const answer = await resp.json();
        await pc.setRemoteDescription(answer);
        console.log("Connection established");
      }

      pc.oniceconnectionstatechange = () => {
        console.log("ICE state:", pc.iceConnectionState);
      };

      function trackFPS() {
        frameCount++;
        const now = performance.now();
        if (now - lastFrameTime >= 1000) {
          fps = Math.round((frameCount * 1000) / (now - lastFrameTime));
          fpsEl.textContent = `FPS: ${fps}`;
          frameCount = 0;
          lastFrameTime = now;
        }
        requestAnimationFrame(trackFPS);
      }

      requestAnimationFrame(trackFPS);
    </script>
  </body>
</html>
